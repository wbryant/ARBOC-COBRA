<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>abcsmc &#8212; ABC-SMC for GEM development 2.7.8 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.7.8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for abcsmc</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">ABC-SMC for COBRA models v0.2</span>
<span class="sd">Copyright 2017 William A. Bryant</span>

<span class="sd">ABSTRACT</span>
<span class="sd">========</span>

<span class="sd">This module undertakes Approximate Bayesian Computation using a Sequential</span>
<span class="sd">Monte Carlo approach (ABC-SMC) to assess proposed additions and uncertain </span>
<span class="sd">enzyme/reaction relationships in a COBRA constraint-based metabolic model, and</span>
<span class="sd">find a combination of additions and removals of reactions and enzyme/reaction </span>
<span class="sd">relationships to and from an original model that produces a model with </span>
<span class="sd">maximum parsimony with a particular set of experimental observations.   </span>

<span class="sd">SUMMARY</span>
<span class="sd">=======</span>

<span class="sd">A specific reaction can be catalysed by one or more (or no) enzymes, which are</span>
<span class="sd">either known or unknown.  The assertion that a particular reaction is catalysed</span>
<span class="sd">by a particular enzyme, a Reaction/Enzyme Link (or REL), is tested in this</span>
<span class="sd">algorithm.  The algorithm requires as input a full model including all known and</span>
<span class="sd">proposed RELs, a set of experiments to determine the congruence of model and </span>
<span class="sd">experiment, and a confidence estimation for the existence of each REL.</span>

<span class="sd">The algorithm requires a set of parameters to estimate.  In this case the</span>
<span class="sd">existence of a particular REL is cast as a boolean parameter and prior confidence</span>
<span class="sd">for the existence of that REL is taken from the confidence estimation provided.</span>
<span class="sd">The existence of all RELs with a confidence less than 1 are included as </span>
<span class="sd">parameters in the ABC-SMC and will be either included in or excluded from each</span>
<span class="sd">proposed model created by the algorithm.</span>

<span class="sd">The algorithm will propose a large number of alternative models, calculating</span>
<span class="sd">for them the congruence with the experimental data provided.  Models will be </span>
<span class="sd">accepted if their distance measure form the experimental data falls below a</span>
<span class="sd">specified value (epsilon).  Once N models have been found that are accepted,</span>
<span class="sd">epsilon is reduced and new models are proposed by selecting a random accepted </span>
<span class="sd">model from the previous step and perturbing it.  At each step both epsilon and</span>
<span class="sd">the perturbation strength are reduced until a set of N models is settled upon,</span>
<span class="sd">having a low epsilon.</span>

<span class="sd">The output is therefore a set of N models, each with a high congruence with the</span>
<span class="sd">observed experimental data.  The confidence for the existence of each REL in </span>
<span class="sd">reality can then be calculated as the proportion of these models containing </span>
<span class="sd">that REL.      </span>

<span class="sd">For further information on the algorithm and formulation of inputs, see the </span>
<span class="sd">accompanying paper.</span>

<span class="sd">LICENSE</span>
<span class="sd">=======</span>

<span class="sd">This program is free software, distributed under the terms of the GNU GPL:</span>
<span class="sd">you can redistribute it and/or modify it under the terms of the GNU General</span>
<span class="sd">Public License as published by the Free Software Foundation, either version 3</span>
<span class="sd">of the License, or (at your option) any later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful,</span>
<span class="sd">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">GNU General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU General Public License</span>
<span class="sd">along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">INSTALLATION</span>
<span class="sd">============</span>

<span class="sd">This module does not need to be installed; if the directory containing this</span>
<span class="sd">file is in the PYTHONPATH, it can be imported using:</span>

<span class="sd">`import abcsmc`</span>

<span class="sd">PREREQUISITES</span>
<span class="sd">=============</span>

<span class="sd">This module has been tested with Python 2.7</span>

<span class="sd">Required non-standard Python packages (tested versions specified in brackets):</span>

<span class="sd">- COBRApy (0.4.0b4)</span>
<span class="sd">- NumPy (1.10.4)</span>
<span class="sd">- LibSBML (5.12.1) for SBML import and export</span>
<span class="sd">- Pyparsing (2.0.3) for GPR &lt;--&gt; list of enzymes translation</span>

<span class="sd">This package also requires the installation of a compatible linear optimisation</span>
<span class="sd">program.  Testing has shown Gurobi to be up to 30 times faster than the free</span>
<span class="sd">GLPK program, and is available for free with an academic license when used </span>
<span class="sd">solely for the purposes of research.</span>

<span class="sd">EXAMPLE USAGE</span>
<span class="sd">=============</span>
<span class="sd">Most C{AbcProblem} arguments are optional (or conditionally optional), the</span>
<span class="sd">following are required:</span>

<span class="sd">- An SBML file containing the model including predicted RELs</span>
<span class="sd">- An experiment file [1]_ containing results of gene essentiality analyses</span>
<span class="sd">- if the &#39;include_all&#39; variable is set to False (default) then a list </span>
<span class="sd">  of candidate RELs for inclusion/exclusion must be supplied (e.g.</span>
<span class="sd">  &#39;example/candidate_rels.tsv&#39;)</span>

<span class="sd">Default values for variables are set for the purposes of testing, rather than</span>
<span class="sd">full analysis.  This example uses non-default values for several optional</span>
<span class="sd">variables.    </span>

<span class="sd">Create problem object:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    abc_problem = AbcProblem(</span>
<span class="sd">        model_file=&#39;example/model.xml&#39;,</span>
<span class="sd">        experiments_file=&#39;example/experiments.xml&#39;,</span>
<span class="sd">        prior_file=&#39;example/candidate_rels.tsv&#39;,</span>
<span class="sd">        particles_per_population=20,</span>
<span class="sd">        num_populations_max=6</span>
<span class="sd">     )</span>


<span class="sd">.. [1] The experiment file has a specific format, as set out in the file</span>
<span class="sd">       &#39;example/experiments.tsv&#39;</span>

<span class="sd">@author: wbryant</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">cobra.flux_analysis</span> <span class="k">import</span> <span class="n">find_blocked_reactions</span>
<span class="kn">from</span> <span class="nn">cobra.core</span> <span class="k">import</span> <span class="n">ArrayBasedModel</span>
<span class="kn">from</span> <span class="nn">cobra.io.sbml</span> <span class="k">import</span> <span class="n">create_cobra_model_from_sbml_file</span> 
<span class="kn">from</span> <span class="nn">cobra.manipulation.delete</span> <span class="k">import</span> <span class="n">delete_model_genes</span><span class="p">,</span> <span class="n">undelete_model_genes</span><span class="p">,</span> <span class="n">find_gene_knockout_reactions</span>
<span class="kn">from</span> <span class="nn">local_gene_parser</span> <span class="k">import</span> <span class="n">gene_parser</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">ln</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">log10</span><span class="p">,</span> <span class="n">ceil</span><span class="p">,</span> <span class="n">exp</span>
<span class="kn">import</span> <span class="nn">shelve</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">re</span>
 
<span class="k">class</span> <span class="nc">AbcProblem</span><span class="p">():</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">model_file</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">prior_dict</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>
            <span class="n">prior_file</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">experiments</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">experiments_file</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">particles_per_population</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">num_populations_max</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">rel_priors</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>
            <span class="n">default_prior_value</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span>
            <span class="n">enzyme_limit</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">objective_name</span> <span class="o">=</span> <span class="s">&#39;Biomass&#39;</span><span class="p">,</span>
            <span class="n">epsilon_0</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">epsilon_T</span> <span class="o">=</span> <span class="mf">0.285</span><span class="p">,</span>
            <span class="n">p_0</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>
            <span class="n">include_all</span><span class="o">=</span><span class="k">False</span><span class="p">,</span>
            <span class="n">biomass_id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">original_model_rxn_ids</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">solver</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">prior_multiplier</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">test_type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">test_model_pre_abc</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">include_fn_reactions</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Set up a COBRA model for ABC-SMC improvement</span>
<span class="sd">        </span>
<span class="sd">        num_populations = number of iterations to run through;</span>
<span class="sd">        model = ExtendedCobraModel to be tested;</span>
<span class="sd">        get_epsilon = a function of t to calculate epsilon;</span>
<span class="sd">        get_p_transition = a function of t to calculate p_transition;</span>
<span class="sd">        abc_reactions: list of reaction IDs to be included;</span>
<span class="sd">        prior_dict: dictionary of predefined prior values for specific reactions (rxn ID is key);</span>
<span class="sd">        rel_priors: a list with entries so - [&#39;base_rxn_id&#39;,[gene_list],prior];</span>
<span class="sd">        default_prior: default prior;</span>
<span class="sd">        include_all: if True, include all non-exchange reactions in the ABC</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">particles_per_population</span> <span class="ow">or</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">num_populations_max</span> <span class="ow">or</span> <span class="mi">5</span>
        <span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span> <span class="ow">or</span> <span class="s">&#39;glpk&#39;</span>
        <span class="n">biomass_id</span> <span class="o">=</span> <span class="n">biomass_id</span> <span class="ow">or</span> <span class="s">&#39;Biomass0&#39;</span>
        <span class="n">experiments_file</span> <span class="o">=</span> <span class="n">experiments_file</span> <span class="ow">or</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_type</span> <span class="o">=</span> <span class="n">test_type</span> <span class="ow">or</span> <span class="k">None</span>
        <span class="n">test_model_pre_abc</span> <span class="o">=</span> <span class="n">test_model_pre_abc</span> <span class="ow">or</span> <span class="k">False</span>
        <span class="k">if</span> <span class="n">include_fn_reactions</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">include_fn_reactions</span> <span class="o">=</span> <span class="k">True</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Loading model ...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">create_extended_model</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span><span class="n">biomass_id</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Model not specified, exiting ...&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    
        
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Loading experiments ...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">experiments_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">import_expt_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">objective_id</span> <span class="o">=</span> <span class="n">biomass_id</span><span class="p">,</span> <span class="n">data_file</span><span class="o">=</span><span class="n">experiments_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">experiments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">experiments</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Experiments not specified, exiting ...&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        
        <span class="k">if</span> <span class="n">original_model_rxn_ids</span><span class="p">:</span>
            <span class="c">## Test original model</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Testing original model ...&quot;</span><span class="p">)</span>
            <span class="n">model_orig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="n">model_orig</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reaction</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">original_model_rxn_ids</span><span class="p">:</span>
                    <span class="n">reaction</span><span class="o">.</span><span class="n">remove_from_model</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">repair</span><span class="p">()</span>     
            <span class="n">original_results</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">conduct_experiments</span><span class="p">(</span><span class="n">model_orig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot; =&gt; Results:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">original_results</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>    
                 
        <span class="k">if</span> <span class="n">test_model_pre_abc</span><span class="p">:</span>
            <span class="c">## Test full model</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Testing full model ...&quot;</span><span class="p">)</span>
            <span class="n">initial_results</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">conduct_experiments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot; =&gt; Results:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">initial_results</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>        
        
        
        
        <span class="c">## Give total numbers of positive and negative results for calculating test cutoffs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_expts_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_expts_neg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">expt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expt</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_expts_pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_expts_neg</span> <span class="o">+=</span> <span class="mi">1</span>       
        <span class="bp">self</span><span class="o">.</span><span class="n">num_rxns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="p">)</span>
        
<span class="c">#         ## Only a few enzymes will be completely incorrect, and be replaceable </span>
<span class="c">#         ## by an alternative.  Set prior for non-enzyme enzrxns to 1/num_rxns </span>
<span class="c">#         ## in model.</span>
<span class="c">#         self.non_enz_prior = 1/float(self.num_rxns)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">p_0</span> <span class="o">=</span> <span class="n">p_0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_0</span> <span class="o">=</span> <span class="n">epsilon_0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_T</span> <span class="o">=</span> <span class="n">epsilon_T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="ow">or</span> <span class="mf">0.01</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_p_transition</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_epsilon</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_set_prev</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_set_prev_unnorm</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_set_prev</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_set</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_set</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_all</span><span class="o">=</span><span class="n">include_all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_prior_value</span><span class="o">=</span><span class="n">default_prior_value</span>
        <span class="n">abc_reactions</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c">## Separate reactions specified in rel_priors, to allow specification </span>
        <span class="c">## of individual REL priors</span>
        <span class="k">if</span> <span class="n">rel_priors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rxn_id</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">rel_priors</span><span class="p">:</span>
                <span class="n">abc_reactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_id</span><span class="p">)</span>
        
        <span class="c">## Set particle ID format according to how many particles there are</span>
        <span class="n">id_length</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_format</span> <span class="o">=</span> <span class="s">&quot;{:0&quot;</span> <span class="o">+</span> <span class="n">id_length</span> <span class="o">+</span> <span class="s">&quot;d}&quot;</span>
        
        <span class="c">## Initialise results variables, for storing run results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_theta</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_w</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thetas_selected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_theta_dict</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_all</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Including all non-exchange reactions&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reaction</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;EX_&#39;</span><span class="p">):</span>
                    <span class="n">abc_reactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reaction</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">{} reactions in total&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">abc_reactions</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Pre-priors: {} reactions included&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">abc_reactions</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Loading prior values ...&quot;</span><span class="p">)</span>
        <span class="n">model_reaction_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">reaction</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prior_dict</span><span class="p">:</span>
            <span class="n">prior_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">prior_file</span><span class="p">:</span>
                <span class="n">f_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">prior_file</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
                    <span class="n">details</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_reaction_ids</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;At least one reaction ID is not recognised (&#39;{}&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="k">for</span> <span class="n">reaction_id</span> <span class="ow">in</span> <span class="n">model_reaction_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">]:</span>
                            <span class="nb">print</span> <span class="n">reaction_id</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">prior_dict</span><span class="p">[</span><span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">prior_dict</span><span class="p">[</span><span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_prior_value</span>
                    <span class="c">#print(&quot;\t&#39;{}&#39;:\t&#39;{}&#39;&quot;.format(details[0],prior_dict[details[0]]))</span>
                <span class="n">f_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;{} in prior_dict&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prior_dict</span><span class="p">)))</span>
        
        <span class="k">for</span> <span class="n">rxn_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">prior_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">abc_reactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_id</span><span class="p">)</span>
        <span class="n">abc_reactions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">abc_reactions</span><span class="p">))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Post-priors: {} reactions included&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">abc_reactions</span><span class="p">)))</span>
        
        <span class="c">## Split all included reactions into individual enzyme/reaction pairs </span>
        <span class="c">## and assign prior values according to prior_dict</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">loop_counter</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">abc_reactions</span><span class="p">),</span><span class="s">&#39;Splitting ABC reactions&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rxn_id</span> <span class="ow">in</span> <span class="n">abc_reactions</span><span class="p">:</span>        
            <span class="n">enzrxn_ids</span><span class="p">,</span> <span class="n">non_enz_rxn_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">split_rxn_by_enzymes</span><span class="p">(</span><span class="n">rxn_id</span><span class="p">,</span> <span class="n">enzyme_limit</span><span class="p">)</span>
            <span class="n">num_enzrxns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">enzrxn_ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_enzrxns</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">num_enzrxns</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">rxn_id</span> <span class="ow">in</span> <span class="n">prior_dict</span><span class="p">:</span>
                <span class="n">prior_value</span> <span class="o">=</span> <span class="n">prior_dict</span><span class="p">[</span><span class="n">rxn_id</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">num_enzrxns</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#prior_value = default_prior_value/sqrt(float(num_enzrxns))</span>
                <span class="n">prior_value</span> <span class="o">=</span> <span class="n">default_prior_value</span>
            <span class="k">if</span> <span class="n">enzrxn_ids</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">enzrxn_id</span> <span class="ow">in</span> <span class="n">enzrxn_ids</span><span class="p">:</span>
                    <span class="n">prior_dict</span><span class="p">[</span><span class="n">enzrxn_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_value</span>
                <span class="k">if</span> <span class="n">non_enz_rxn_id</span><span class="p">:</span>
                    <span class="n">prior_dict</span><span class="p">[</span><span class="n">non_enz_rxn_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_value</span><span class="o">/</span><span class="mf">100.0</span>
            <span class="k">else</span><span class="p">:</span>        
                <span class="k">if</span> <span class="n">non_enz_rxn_id</span><span class="p">:</span>
                    <span class="n">prior_dict</span><span class="p">[</span><span class="n">non_enz_rxn_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_prior_value</span>
            <span class="n">counter</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">counter</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>


        <span class="k">if</span> <span class="n">rel_priors</span><span class="p">:</span>
            <span class="c">## Apply belief about rxn/gene/enzyme relationships</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Adding REL priors ...&quot;</span><span class="p">)</span>
            <span class="n">prior_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_rel_priors</span><span class="p">(</span><span class="n">rel_priors</span><span class="p">,</span> <span class="n">prior_dict</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;REL priors added.&quot;</span><span class="p">)</span>
        
        <span class="n">abc_running_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior_dict</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot; =&gt; {} RELs included&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">abc_running_total</span><span class="p">))</span>

        <span class="c">## Create original lb/ub vars for reference</span>
        <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
            <span class="n">rxn</span><span class="o">.</span><span class="n">lb_orig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">)</span>
            <span class="n">rxn</span><span class="o">.</span><span class="n">ub_orig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">include_fn_reactions</span><span class="p">:</span>
            <span class="c">## FIND RELS PRODUCING FALSE NEGATIVE PREDICTIONS AND ADD TO ABC-SMC        </span>
            <span class="c">## For each gene in experiments, determine set of reactions that are stopped by gene deletion.</span>
            <span class="n">prior_fn_value</span> <span class="o">=</span> <span class="mf">0.95</span>  
            <span class="n">counter</span> <span class="o">=</span> <span class="n">loop_counter</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">),</span><span class="s">&quot;Finding inessential genes incorrectly predicted as essential&quot;</span><span class="p">)</span>
            <span class="n">expt_num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">expt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
                <span class="n">expt_num</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">expt_no_genotype</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">expt</span><span class="p">)</span>
                <span class="n">expt_no_genotype</span><span class="o">.</span><span class="n">genotype</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expt</span><span class="o">.</span><span class="n">genotype</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">expt</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fn</span><span class="p">:</span>
                        <span class="c">## Which reaction is implicated?</span>
                        <span class="n">ko_rxns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_genotype</span><span class="p">(</span><span class="n">expt</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span> <span class="n">return_ko_rxns</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">unset_genotype</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ko_rxns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ko_rxns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">ko_rxns_essential</span> <span class="o">=</span> <span class="p">[</span><span class="n">ko_rxns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c">## Find model-breaking reaction(s)</span>
                            <span class="n">ko_rxns_essential</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">ko_rxns</span><span class="p">:</span>
                                <span class="n">rxn</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">rxn</span><span class="o">.</span><span class="n">upper_bound</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">fn_rxn</span> <span class="o">=</span> <span class="n">expt_no_genotype</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">fn_rxn</span><span class="p">:</span>
                                    <span class="n">ko_rxns_essential</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                                <span class="n">rxn</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">lb_orig</span>
                                <span class="n">rxn</span><span class="o">.</span><span class="n">upper_bound</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ub_orig</span>
                        <span class="k">for</span> <span class="n">rxn_id</span> <span class="ow">in</span> <span class="n">ko_rxns_essential</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c">## Already in prior dict? Amend if new prior lower</span>
                                <span class="n">prior_val</span> <span class="o">=</span> <span class="n">prior_dict</span><span class="p">[</span><span class="n">rxn_id</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">prior_val</span> <span class="o">&gt;</span> <span class="n">prior_fn_value</span><span class="p">:</span>
                                    <span class="n">prior_dict</span><span class="p">[</span><span class="n">rxn_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_fn_value</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="c">## Add to prior dict</span>
                                <span class="n">prior_dict</span><span class="p">[</span><span class="n">rxn_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_fn_value</span>   
                <span class="n">counter</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">counter</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
             
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot; =&gt; {} RELs added&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prior_dict</span><span class="p">)</span><span class="o">-</span><span class="n">abc_running_total</span><span class="p">))</span>
            
            
        <span class="c">## All beliefs about reactions included in the model are now in prior_dict.</span>
        <span class="c">## Any reaction not in prior_dict is not in the ABC and should always be included.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prior_dict</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">theta_rxn_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rxn_theta_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">rxn_id</span><span class="p">,</span> <span class="n">prior_value</span> <span class="ow">in</span> <span class="n">prior_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">theta_rxn_map</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">rxn_id</span><span class="p">)</span>
            <span class="n">rxn_theta_map</span><span class="p">[</span><span class="n">rxn_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_set_original</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">)</span>       
        <span class="c">## Use prior_multiplier to adjust entire prior enabling tuning of particle finders</span>
        <span class="k">if</span> <span class="n">prior_multiplier</span> <span class="ow">or</span> <span class="p">(</span><span class="n">prior_multiplier</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Using prior multiplier ...&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prior_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">):</span>
                <span class="n">prior_val_new</span> <span class="o">=</span> <span class="n">prior_val</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">prior_val</span><span class="p">)</span><span class="o">*</span><span class="n">prior_multiplier</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_val_new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_estimate</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">)</span>
        
        
        <span class="c">## Calculate ln_pi_max for calculation of pi_rel in weight calculations</span>
        <span class="n">ln_pi_max</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">ln_pi_max</span> <span class="o">+=</span> <span class="n">ln</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_pi_max</span> <span class="o">+=</span> <span class="n">ln</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">ln_pi_max</span> <span class="o">=</span> <span class="n">ln_pi_max</span>
        
        <span class="c">## Finding media with &gt;10 experiments, for ensuring testing does not waste time</span>
        <span class="n">media_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">expt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
            <span class="n">media_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expt</span><span class="o">.</span><span class="n">medium_components</span><span class="p">)</span>
        <span class="n">media_count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">media_list</span><span class="p">)</span>
        <span class="n">precalc_media_lists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">medium_count</span> <span class="ow">in</span> <span class="n">media_count</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">medium_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">precalc_media_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">medium_count</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>        
        <span class="n">precalc_media</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">medium_list</span> <span class="ow">in</span> <span class="n">precalc_media_lists</span><span class="p">:</span>
            <span class="n">precalc_medium</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">medium_list</span><span class="p">:</span>
                <span class="n">precalc_medium</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
            <span class="n">precalc_media</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precalc_medium</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precalc_media</span> <span class="o">=</span> <span class="n">precalc_media</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precalc_media_frozensets</span> <span class="o">=</span> <span class="n">precalc_media_lists</span>
        
        <span class="c">## FIND ESSENTIAL REACTIONS HERE for precalc media</span>
        <span class="c">## For each reaction, find all RELs</span>
        <span class="n">abc_reaction_lists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rxn_id</span> <span class="ow">in</span> <span class="n">abc_reactions</span><span class="p">:</span>
            <span class="n">rxn_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reaction</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">rxn_id</span><span class="p">):</span>
                    <span class="n">rxn_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reaction</span><span class="p">)</span>
            <span class="n">abc_reaction_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_list</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">test_model_pre_abc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Testing full model with precalculated media ...&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">medium</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">precalc_media</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_medium</span><span class="p">(</span><span class="n">medium</span><span class="p">)</span>
                <span class="n">precalc_fail</span> <span class="o">=</span> <span class="k">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">opt</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">5</span><span class="p">:</span>
                    <span class="n">precalc_fail</span> <span class="o">=</span> <span class="k">True</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Initial model did not run on precalc medium:&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">met</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">medium</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s">&quot; - {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">met</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">precalc_fail</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Failed on precalc media, exiting ...&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&quot;... done.&quot;</span><span class="p">)</span>

        <span class="n">essential_abc_reaction_sets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">count_rxn_lists</span> <span class="o">=</span> <span class="n">loop_counter</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">abc_reaction_lists</span><span class="p">),</span>
            <span class="s">&#39;Testing ABC reactions for essentiality&#39;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">rxn_list</span> <span class="ow">in</span> <span class="n">abc_reaction_lists</span><span class="p">:</span>
            <span class="n">essential_rxn_set</span> <span class="o">=</span> <span class="k">False</span>
            <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">rxn_list</span><span class="p">:</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">upper_bound</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">medium</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">precalc_media</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_medium</span><span class="p">(</span><span class="n">medium</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">opt</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">5</span><span class="p">:</span>
                    <span class="n">essential_rxn_set</span> <span class="o">=</span> <span class="k">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">essential_rxn_set</span><span class="p">:</span>
                <span class="n">essential_abc_reaction_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">rxn_list</span><span class="p">:</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">lb_orig</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">upper_bound</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ub_orig</span>
            <span class="n">count_rxn_lists</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">count_rxn_lists</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot; =&gt; {} ABC reactions essential.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">essential_abc_reaction_sets</span><span class="p">)))</span>
        
        <span class="c">## CONVERT ESSENTIAL REACTION SETS TO THETA SUBSETS - IF ONLY A SINGLE</span>
        <span class="c">## THETA, SET PRIOR TO ONE!</span>
        <span class="n">essential_theta_sets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rxn_list</span> <span class="ow">in</span> <span class="n">essential_abc_reaction_sets</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rxn_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">[</span><span class="n">rxn_theta_map</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">id</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prior_estimate</span><span class="p">[</span><span class="n">rxn_theta_map</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">id</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theta_indices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">rxn_list</span><span class="p">:</span>
                    <span class="n">theta_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_theta_map</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
                <span class="n">essential_theta_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">theta_indices</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">essential_theta_sets</span> <span class="o">=</span> <span class="n">essential_theta_sets</span>

        <span class="c">## FIND BLOCKED REACTIONS AND SET BOUNDS TO 0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Setting bounds of blocked reactions to 0 ...&quot;</span><span class="p">)</span>
        <span class="n">blocked_rxn_ids</span> <span class="o">=</span> <span class="n">find_blocked_reactions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">open_exchanges</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
        <span class="n">num_restricted</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">rxn_id</span> <span class="ow">in</span> <span class="n">blocked_rxn_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">blocked_reaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">rxn_id</span><span class="p">)</span>
                <span class="n">blocked_reaction</span><span class="o">.</span><span class="n">upper_bound</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">blocked_reaction</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">num_restricted</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&quot; - &#39;Blocked&#39; reaction &#39;{}&#39; could not be found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">rxn_id</span>
                <span class="p">))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot; =&gt; {} reactions had bounds restricted to 0.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_restricted</span><span class="p">))</span>
        
        
        <span class="n">num_essential_expts</span> <span class="o">=</span> <span class="k">None</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_type</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_type</span> <span class="o">==</span> <span class="s">&#39;essential_and_orphan_mets&#39;</span><span class="p">):</span>        
            <span class="c"># get genes in model</span>
            <span class="n">gene_set_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">gene</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">]</span>
            <span class="n">num_essential_expts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">expt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expt</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gene_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">expt</span><span class="o">.</span><span class="n">genotype</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">gene_set</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">gene_set_all</span><span class="p">):</span>
                        <span class="n">num_essential_expts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;There are {} experiments showing essentiality&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_essential_expts</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_essential_expts</span> <span class="o">=</span> <span class="n">num_essential_expts</span>
        
        
<span class="c">#         ## Test full model balanced accuracy</span>
<span class="c">#         print(&quot;Testing full ABC model ...&quot;)</span>
<span class="c">#         particle_full = self.initialise_particle(0)</span>
<span class="c">#         particle_full.conduct_experiments()</span>
<span class="c">#         print(&quot; =&gt; balanced accuracy = {}&quot;.format(1.0-particle_full.result))</span>
<span class="c"># #         print(&quot; =&gt; Results:\n&quot;)</span>
<span class="c"># #         initial_results.stats() </span>

        <span class="k">if</span> <span class="n">test_model_pre_abc</span><span class="p">:</span>
            <span class="c">## Test full model</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Testing full ABC model ...&quot;</span><span class="p">)</span>
            <span class="n">initial_results</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">conduct_experiments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot; =&gt; Results:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">initial_results</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>         
       
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;ABC initialisation complete.&quot;</span><span class="p">)</span>
                
    
    <span class="k">def</span> <span class="nf">set_rel_priors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_priors</span><span class="p">,</span> <span class="n">prior_dict</span><span class="p">,</span> <span class="n">include_all</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Where there is belief about certain enzyme/reaction pairs, </span>
<span class="sd">        apply this to the relevant reaction priors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rel_priors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rel_prior</span> <span class="ow">in</span> <span class="n">rel_priors</span><span class="p">:</span>
                <span class="n">base_rxn_id</span> <span class="o">=</span> <span class="n">rel_prior</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">gene_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rel_prior</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">prior_value</span> <span class="o">=</span> <span class="n">rel_prior</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">id_string</span> <span class="o">=</span> <span class="n">base_rxn_id</span> <span class="o">+</span> <span class="s">&quot;(_enz[0-9]+)*$&quot;</span>
                <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">id_string</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                        <span class="n">enzrxn_gene_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gene</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">genes</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">enzrxn_gene_set</span> <span class="o">|</span> <span class="n">gene_set</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">enzrxn_gene_set</span> <span class="o">&amp;</span> <span class="n">gene_set</span><span class="p">):</span>
                            <span class="n">prior_dict</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_value</span>
        <span class="k">return</span> <span class="n">prior_dict</span>


    <span class="k">def</span> <span class="nf">initialise_particle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particle_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new particle from the current ABC timepoint.&quot;&quot;&quot;</span>
        <span class="n">particle</span> <span class="o">=</span> <span class="n">Particle</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theta_set_prev</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_set_prev</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_t</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_t</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span>
            <span class="n">particle_id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_expts_pos</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_expts_neg</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ln_pi_max</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">precalc_media</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">precalc_media_frozensets</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prior_estimate</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">essential_theta_sets</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_type</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_essential_expts</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prior_set_original</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">particle</span>
    
    <span class="k">def</span> <span class="nf">create_population_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">population_t</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">particle_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">particle_id_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">particle_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">population_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialise_particle</span><span class="p">(</span><span class="n">particle_id_string</span><span class="p">))</span>
    
        
    <span class="k">def</span> <span class="nf">record_previous_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta_accepted_set</span><span class="p">,</span> <span class="n">ln_w_accepted_set</span><span class="p">,</span> <span class="n">distance_set</span><span class="p">,</span> <span class="n">proposed_theta_idx_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the results from the previous run to the full lists of results.&quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">results_theta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta_accepted_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distance_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_set_prev</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thetas_selected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proposed_theta_idx_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_theta_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta_accepted_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_set_prev</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">theta_accepted_set</span><span class="p">)</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">ln_w_accepted_set</span> <span class="o">=</span> <span class="n">ln_w_accepted_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_prior_estimate</span><span class="p">()</span>     
     
    <span class="k">def</span> <span class="nf">create_prior_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use theta_accepted_set to estimate new prior for determining transition probabilities.&quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_estimate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rxn_presence</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">results_theta</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">rxn_presence</span><span class="p">:</span>
            <span class="n">rxn_prior</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rxn</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rxn</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prior_estimate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_prior</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">step_forwards</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Increment time and calculate new problem parameters.&quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">update_weights</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;This was the final run.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_p_transition</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_epsilon</span><span class="p">()</span>               
           
        
    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln_weights</span> <span class="o">=</span> <span class="k">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Normalise outputed weights and update w_set_prev.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ln_weights</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">ln_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_w_accepted_set</span>
        <span class="n">max_ln_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ln_weights</span><span class="p">)</span>
        <span class="n">ln_ws_full</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ln_w</span> <span class="ow">in</span> <span class="n">ln_weights</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ln_w</span><span class="p">:</span>
                <span class="n">ln_ws_full</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_ws_full</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ln_w</span><span class="o">-</span><span class="n">max_ln_w</span><span class="p">)</span>
        <span class="n">weights_unnorm</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_w</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln_w</span> <span class="ow">in</span> <span class="n">ln_ws_full</span><span class="p">]</span>
        <span class="n">sum_weights</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights_unnorm</span><span class="p">))</span>
        <span class="n">weights_norm</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">/</span><span class="n">sum_weights</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights_unnorm</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_set_prev_unnorm</span> <span class="o">=</span> <span class="n">weights_unnorm</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">w_set_prev</span> <span class="o">=</span> <span class="n">weights_norm</span>
    
    <span class="k">def</span> <span class="nf">get_epsilon_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">step_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon_0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_T</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">epsilon_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_0</span> <span class="o">-</span> <span class="n">step_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_t</span> <span class="o">=</span> <span class="n">epsilon_t</span>
    
    <span class="k">def</span> <span class="nf">get_epsilon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">## Taking into account distance scores for the previous population, </span>
        <span class="c">## propose a new epsilon, or default to linear epsilon selection</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_0</span>
            <span class="k">return</span> <span class="k">None</span>
        <span class="n">distance_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">distance_set_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">distance_set</span><span class="p">)</span>
        <span class="n">quantile_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">distance_set</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_t</span> <span class="o">=</span> <span class="n">distance_set_sorted</span><span class="p">[</span><span class="n">quantile_idx</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">get_p_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">step_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">p_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_0</span> <span class="o">-</span> <span class="n">step_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_t</span> <span class="o">=</span> <span class="n">p_t</span>
    
    <span class="k">def</span> <span class="nf">test_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thetaTest</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply a manually defined theta and test against the experiments in </span>
<span class="sd">        the ABC problem, returning a ResultSet instance with the results in it.&quot;&quot;&quot;</span>
        
        <span class="n">particleTest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialise_particle</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">particleTest</span><span class="o">.</span><span class="n">theta_proposed</span> <span class="o">=</span> <span class="n">thetaTest</span>    
        <span class="n">particleTest</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">particleTest</span><span class="o">.</span><span class="n">apply_proposed_theta</span><span class="p">()</span>
        <span class="n">particleTest</span><span class="o">.</span><span class="n">conduct_experiments</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">particleTest</span><span class="o">.</span><span class="n">full_results</span>
    
    <span class="k">def</span> <span class="nf">export_particle_rels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timepoint</span><span class="p">,</span> <span class="n">particle_index</span><span class="p">,</span> <span class="n">rel_output_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export RELs from any particle from any of the timepoints.&quot;&quot;&quot;</span>
        <span class="n">f_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">rel_output_file</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="c">### For reaction in model,</span>
        <span class="c">###    if theta[t, index] == 1: export RELs </span>
        <span class="c">###    elif not in index: export RELs.</span>
        <span class="n">f_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
<div class="viewcode-block" id="Particle"><a class="viewcode-back" href="../index.html#abcsmc.Particle">[docs]</a><span class="k">class</span> <span class="nc">Particle</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;A self-contained ABC particle that will return an accepted parameter set and its weight.&quot;&quot;&quot;</span>
     
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">theta_set_prev</span><span class="p">,</span>
            <span class="n">w_set_prev</span><span class="p">,</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">experiments</span><span class="p">,</span>
            <span class="n">epsilon_curr</span><span class="p">,</span>
            <span class="n">prior_set</span><span class="p">,</span>
            <span class="n">p_transition_curr</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">N</span><span class="p">,</span>
            <span class="n">particle_id</span><span class="p">,</span>
            <span class="n">num_expts_pos</span><span class="p">,</span>
            <span class="n">num_expts_neg</span><span class="p">,</span>
            <span class="n">ln_pi_max</span><span class="p">,</span>
            <span class="n">precalc_media</span><span class="p">,</span>
            <span class="n">precalc_media_frozensets</span><span class="p">,</span>
            <span class="n">prior_estimate</span><span class="p">,</span>
            <span class="n">essential_theta_sets</span><span class="p">,</span>
            <span class="n">test_type</span><span class="p">,</span>
            <span class="n">num_essential_expts</span><span class="p">,</span>
            <span class="n">prior_set_original</span><span class="p">):</span>
         
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_set_prev</span> <span class="o">=</span> <span class="n">theta_set_prev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_set_prev</span> <span class="o">=</span> <span class="n">w_set_prev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span> <span class="o">=</span> <span class="n">prior_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon_curr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_transition</span> <span class="o">=</span> <span class="n">p_transition_curr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">particle_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_expts_pos</span> <span class="o">=</span> <span class="n">num_expts_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_expts_neg</span> <span class="o">=</span> <span class="n">num_expts_neg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln_pi_max</span> <span class="o">=</span> <span class="n">ln_pi_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precalc_media</span> <span class="o">=</span> <span class="n">precalc_media</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precalc_media_frozensets</span> <span class="o">=</span> <span class="n">precalc_media_frozensets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_estimate</span> <span class="o">=</span> <span class="n">prior_estimate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">essential_theta_sets</span> <span class="o">=</span> <span class="n">essential_theta_sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_type</span> <span class="o">=</span> <span class="n">test_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_essential_expts</span> <span class="o">=</span> <span class="n">num_essential_expts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_set_original</span> <span class="o">=</span> <span class="n">prior_set_original</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">num_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior_set</span><span class="p">)</span>
         
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_sampled</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_sampled_idx</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_accepted</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_proposed</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_results</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="k">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="k">False</span>
        
        <span class="k">return</span> <span class="k">None</span>
    
<div class="viewcode-block" id="Particle.vprint"><a class="viewcode-back" href="../index.html#abcsmc.Particle.vprint">[docs]</a>    <span class="k">def</span> <span class="nf">vprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print if verbose is true - override class verbosity with specified verbosity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">None</span></div>
    
<div class="viewcode-block" id="Particle.reset_prior"><a class="viewcode-back" href="../index.html#abcsmc.Particle.reset_prior">[docs]</a>    <span class="k">def</span> <span class="nf">reset_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prior_multiplier</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set prior to original values, and apply prior_multiplier if specified </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_set_original</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prior_multiplier</span> <span class="ow">or</span> <span class="p">(</span><span class="n">prior_multiplier</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prior_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">):</span>
                <span class="n">prior_val_new</span> <span class="o">=</span> <span class="n">prior_val</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">prior_val</span><span class="p">)</span><span class="o">*</span><span class="n">prior_multiplier</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_val_new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_estimate</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_accepted</span> <span class="o">=</span> <span class="k">None</span>
        <span class="k">return</span> <span class="k">None</span></div>
         
<div class="viewcode-block" id="Particle.propose_theta"><a class="viewcode-back" href="../index.html#abcsmc.Particle.propose_theta">[docs]</a>    <span class="k">def</span> <span class="nf">propose_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sample theta from previous iteration and perturb according to K_t.&quot;&quot;&quot;</span>
         
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="c">## Get theta by sampling</span>
             
            <span class="bp">self</span><span class="o">.</span><span class="n">theta_sampled_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">w_set_prev</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theta_sampled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_set_prev</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_sampled_idx</span><span class="p">]</span>
             
            <span class="c">## Perturb theta using perturbation kernel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theta_proposed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K_t</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">## Sample theta from prior</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theta_proposed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theta_sampled_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></div>
         
<div class="viewcode-block" id="Particle.apply_proposed_theta"><a class="viewcode-back" href="../index.html#abcsmc.Particle.apply_proposed_theta">[docs]</a>    <span class="k">def</span> <span class="nf">apply_proposed_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set constraints on model according to proposed theta.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">param_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_proposed</span><span class="p">):</span>
            <span class="n">reaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">theta_rxn_map</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">param_value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">reaction</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">lb_orig</span>
                <span class="n">reaction</span><span class="o">.</span><span class="n">upper_bound</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">ub_orig</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reaction</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">=</span> <span class="mi">0</span>   
                <span class="n">reaction</span><span class="o">.</span><span class="n">upper_bound</span> <span class="o">=</span> <span class="mi">0</span>          </div>
    
<div class="viewcode-block" id="Particle.ln_pi"><a class="viewcode-back" href="../index.html#abcsmc.Particle.ln_pi">[docs]</a>    <span class="k">def</span> <span class="nf">ln_pi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;find logarithm of the prior for calculating logarithm of weight.&quot;&quot;&quot;</span>
        
        <span class="n">ln_pi</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_accepted</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">ln_pi</span> <span class="o">+=</span> <span class="n">ln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_pi</span> <span class="o">+=</span> <span class="n">ln</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">ln_pi</span> <span class="o">=</span> <span class="n">ln_pi</span></div>
    
<div class="viewcode-block" id="Particle.n_diff_min_and_residuals"><a class="viewcode-back" href="../index.html#abcsmc.Particle.n_diff_min_and_residuals">[docs]</a>    <span class="k">def</span> <span class="nf">n_diff_min_and_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;From the previous accepted theta set, calculate the minimum number </span>
<span class="sd">        of changes from any of them to the accepted theta.&quot;&quot;&quot;</span>
        
        <span class="n">n_diff_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_params</span>
        <span class="n">n_diff_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">theta_prev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_set_prev</span><span class="p">:</span>
            <span class="n">n_diff</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">diff</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">diff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">theta_prev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_accepted</span><span class="p">)])</span>
            <span class="n">n_diff_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_diff</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_diff</span> <span class="o">&lt;</span> <span class="n">n_diff_min</span><span class="p">:</span>
                <span class="n">n_diff_min</span> <span class="o">=</span> <span class="n">n_diff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_diff_res</span> <span class="o">=</span> <span class="p">[</span><span class="n">n_diff</span> <span class="o">-</span> <span class="n">n_diff_min</span> <span class="k">for</span> <span class="n">n_diff</span> <span class="ow">in</span> <span class="n">n_diff_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_diff_min</span> <span class="o">=</span> <span class="n">n_diff_min</span></div>
    
<div class="viewcode-block" id="Particle.calculate_ln_weight_denominator_modified"><a class="viewcode-back" href="../index.html#abcsmc.Particle.calculate_ln_weight_denominator_modified">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_ln_weight_denominator_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the logarithm of the weighted sum of the K_ts for the </span>
<span class="sd">        calculation of weight.</span>
<span class="sd">        </span>
<span class="sd">        For the modified K_t, the shortcut leveraging the fact that all transition </span>
<span class="sd">        probabilities are the same does not work so all must be calculated sequentially.&quot;&quot;&quot;</span>
        
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_transition</span>
        
        <span class="n">weighted_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">w_j</span><span class="p">,</span> <span class="n">theta_j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_set_prev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_set_prev</span><span class="p">):</span>
            <span class="n">weighted_residual</span> <span class="o">=</span> <span class="n">w_j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K_t_modified</span><span class="p">(</span><span class="n">theta_j</span><span class="p">)</span>
            <span class="n">weighted_sum</span> <span class="o">+=</span> <span class="n">weighted_residual</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">pass</span>
<span class="c">#            self.ln_weight_denominator = n_diff_res*(ln(p) + ln(1-p)) + ln(weighted_sum)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;This particle is so distant from every other particle that </span><span class="se">\</span>
<span class="s">                    it has underflown, it will take the maximum value of the </span><span class="se">\</span>
<span class="s">                    weights of the other particles in the population&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ln_weight_denominator</span> <span class="o">=</span> <span class="k">None</span></div>
    
<div class="viewcode-block" id="Particle.calculate_ln_weight_denominator"><a class="viewcode-back" href="../index.html#abcsmc.Particle.calculate_ln_weight_denominator">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_ln_weight_denominator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the logarithm of the weighted sum of the K_ts for the </span>
<span class="sd">        calculation of weight.&quot;&quot;&quot;</span>
        
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_transition</span>
        
        <span class="n">weighted_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">w_j</span><span class="p">,</span> <span class="n">n_diff_res</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_set_prev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_diff_res</span><span class="p">):</span>
            <span class="n">weighted_residual</span> <span class="o">=</span> <span class="n">w_j</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">n_diff_res</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="n">n_diff_res</span>
            <span class="n">weighted_sum</span> <span class="o">+=</span> <span class="n">weighted_residual</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ln_weight_denominator</span> <span class="o">=</span> <span class="n">n_diff_res</span><span class="o">*</span><span class="p">(</span><span class="n">ln</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">ln</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span> <span class="o">+</span> <span class="n">ln</span><span class="p">(</span><span class="n">weighted_sum</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;This particle is so distant from every other particle that </span><span class="se">\</span>
<span class="s">                    it has underflown, it will take the maximum value of the </span><span class="se">\</span>
<span class="s">                    weights of the other particles in the population&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ln_weight_denominator</span> <span class="o">=</span> <span class="k">None</span></div>
            
<div class="viewcode-block" id="Particle.calculate_ln_w"><a class="viewcode-back" href="../index.html#abcsmc.Particle.calculate_ln_w">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_ln_w</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate ln(weight) for this particle.&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ln_w</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ln_pi</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_diff_min_and_residuals</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_ln_weight_denominator</span><span class="p">()</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ln_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_pi</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_weight_denominator</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ln_w</span> <span class="o">=</span> <span class="k">None</span></div>
              
<div class="viewcode-block" id="Particle.find_accepted_theta"><a class="viewcode-back" href="../index.html#abcsmc.Particle.find_accepted_theta">[docs]</a>    <span class="k">def</span> <span class="nf">find_accepted_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span> <span class="o">=</span> <span class="k">False</span><span class="p">,</span> <span class="n">use_ln</span> <span class="o">=</span> <span class="k">True</span><span class="p">,</span> <span class="n">use_simple_K</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">max_tests</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find accepted theta and return it with weight.&quot;&quot;&quot;</span>
         
        <span class="n">count_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">failed_precalc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">failed_theta_sets</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Finding particle:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        
        <span class="k">while</span> <span class="k">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_tests</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">count_attempts</span> <span class="o">&gt;=</span> <span class="n">max_tests</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Too many failed, exiting ...&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Attempts</span><span class="se">\t</span><span class="s">Precalc</span><span class="se">\t</span><span class="s">Thetasets&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s">&quot;{}</span><span class="se">\t</span><span class="s">{}</span><span class="se">\t</span><span class="s">{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count_attempts</span><span class="p">,</span><span class="n">failed_precalc</span><span class="p">,</span><span class="n">failed_theta_sets</span><span class="p">))</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">count_attempts</span> <span class="o">+=</span> <span class="mi">1</span>            

            <span class="bp">self</span><span class="o">.</span><span class="n">propose_theta</span><span class="p">()</span>            
            <span class="n">excluded_theta_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
                <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">t_value</span>
                <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_proposed</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">t_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">running_model</span><span class="o">=</span><span class="k">True</span>
            <span class="k">for</span> <span class="n">essential_theta_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">essential_theta_sets</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">essential_theta_set</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">excluded_theta_set</span><span class="p">):</span>
                    <span class="n">running_model</span><span class="o">=</span><span class="k">False</span>
           
            <span class="k">if</span> <span class="n">running_model</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">apply_proposed_theta</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_type</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_type</span> <span class="o">==</span> <span class="s">&#39;essential_and_orphan_mets&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conduct_experiments_essential_and_orphan_mets</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conduct_experiments</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">result = {:.3f}                                    &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; after {}/{} tests&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tests_checked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tests_total</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="mi">3</span>
                
            <span class="c">## If model is close enough to experiments, accept and return theta and calculated weight</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">failed_precalc</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">failed_theta_sets</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theta_accepted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_proposed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_ln_w</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Accepted particle (result = {})</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot; =&gt; {} total attempts&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count_attempts</span><span class="p">),</span><span class="n">verbose</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot; =&gt; {} failed on precalc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">failed_precalc</span><span class="p">),</span><span class="n">verbose</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot; =&gt; {} failed on theta sets&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">failed_theta_sets</span><span class="p">),</span><span class="n">verbose</span><span class="p">)</span>
                <span class="c">#sys.stdout.write(&quot;.&quot;)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_accepted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_sampled_idx</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&quot;result = {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">{}</span><span class="se">\t</span><span class="s">{}</span><span class="se">\t</span><span class="s">{}</span><span class="se">\t</span><span class="s">{}                            &quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">count_attempts</span><span class="p">,</span>
                    <span class="n">failed_precalc</span><span class="p">,</span>
                    <span class="n">failed_theta_sets</span><span class="p">,</span>
                    <span class="n">count_attempts</span><span class="o">-</span><span class="n">failed_precalc</span><span class="o">-</span><span class="n">failed_theta_sets</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span> <span class="k">None</span></div>
        
<div class="viewcode-block" id="Particle.perturb_param_using_prior"><a class="viewcode-back" href="../index.html#abcsmc.Particle.perturb_param_using_prior">[docs]</a>    <span class="k">def</span> <span class="nf">perturb_param_using_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return p_transition based on current prior estimate for REL idx.&quot;&quot;&quot;</span>
        
        <span class="n">rel_prior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_estimate</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rel_prior</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">:</span>
            <span class="n">rel_prior</span> <span class="o">=</span> <span class="mf">0.95</span>
        <span class="k">if</span> <span class="n">rel_prior</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">rel_prior</span> <span class="o">=</span> <span class="mf">0.05</span>
        
        <span class="n">param_perturbed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">rel_prior</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">param_perturbed</span></div>

<div class="viewcode-block" id="Particle.param_p_sourced"><a class="viewcode-back" href="../index.html#abcsmc.Particle.param_p_sourced">[docs]</a>    <span class="k">def</span> <span class="nf">param_p_sourced</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">param_previous</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the probability of a parameter having come from a previous parameter given a pertubation.&quot;&quot;&quot;</span>

        <span class="n">r_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_estimate</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">p_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_transition</span>
        
        <span class="k">if</span> <span class="n">r_p</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">:</span>
            <span class="n">r_p</span> <span class="o">=</span> <span class="mf">0.95</span>
        <span class="k">if</span> <span class="n">r_p</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">r_p</span> <span class="o">=</span> <span class="mf">0.05</span>        
 
        <span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">param_previous</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p_t</span><span class="o">*</span><span class="n">r_p</span> <span class="o">+</span> <span class="mi">1</span><span class="o">-</span><span class="n">p_t</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">param_previous</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p_t</span><span class="o">*</span><span class="n">r_p</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">param_previous</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p_t</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">r_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">param_previous</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p_t</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">r_p</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">-</span><span class="n">p_t</span></div>
            
<div class="viewcode-block" id="Particle.K_t_modified"><a class="viewcode-back" href="../index.html#abcsmc.Particle.K_t_modified">[docs]</a>    <span class="k">def</span> <span class="nf">K_t_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta_previous</span> <span class="o">=</span> <span class="k">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perturbation function based on current estimated priors for reaction presence parameters. </span>
<span class="sd">         </span>
<span class="sd">        Return a perturbed theta, theta_perturbed, from theta_sampled according to a modified distribution.&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">theta_previous</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="c">## Perturb the parameter set self.theta_sampled</span>
            <span class="n">theta_perturbed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_sampled</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">param_sampled</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_sampled</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_transition</span><span class="p">:</span>
                    <span class="n">param_perturbed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perturb_param_using_prior</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">param_perturbed</span> <span class="o">=</span> <span class="n">param_sampled</span>
                <span class="n">theta_perturbed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_perturbed</span> 
            <span class="k">return</span> <span class="n">theta_perturbed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">## Output the probability of a transition to self.theta_sampled from theta_previous    </span>
            <span class="c">#added_thetas = self.theta_accepted + theta_previous</span>
            <span class="n">probability</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">ln_p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_accepted</span><span class="p">):</span>
                <span class="n">p_transition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_p_sourced</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span><span class="n">theta_previous</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="n">ln_p</span> <span class="o">+=</span> <span class="n">ln</span><span class="p">(</span><span class="n">p_transition</span><span class="p">)</span>
                <span class="n">probability</span> <span class="o">*=</span> <span class="n">p_transition</span>
            <span class="k">return</span> <span class="n">probability</span><span class="p">,</span> <span class="n">ln_p</span></div>
   
<div class="viewcode-block" id="Particle.K_t"><a class="viewcode-back" href="../index.html#abcsmc.Particle.K_t">[docs]</a>    <span class="k">def</span> <span class="nf">K_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta_previous</span> <span class="o">=</span> <span class="k">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perturbation function!</span>
<span class="sd">         </span>
<span class="sd">        Return a perturbed theta, theta_perturbed, from theta_sampled according to a simple distribution.&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">theta_previous</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="c">## Perturb the parameter set self.theta_sampled</span>
            <span class="n">theta_perturbed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_sampled</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">param_sampled</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_sampled</span><span class="p">):</span>
                <span class="n">param_perturbed</span> <span class="o">=</span> <span class="n">param_sampled</span>
                <span class="k">if</span> <span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_transition</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">param_sampled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">param_perturbed</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">param_sampled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">param_perturbed</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">theta_perturbed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_perturbed</span> 
            <span class="k">return</span> <span class="n">theta_perturbed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">## Output the probability of a transition to self.theta_sampled from theta_previous    </span>
            <span class="n">added_thetas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_accepted</span> <span class="o">+</span> <span class="n">theta_previous</span>
            <span class="n">probability</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">ln_p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">added_thetas</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ln_p</span> <span class="o">+=</span> <span class="n">ln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_transition</span><span class="p">)</span>
                    <span class="n">probability</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_transition</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ln_p</span> <span class="o">+=</span> <span class="n">ln</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">p_transition</span><span class="p">)</span>
                    <span class="n">probability</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_transition</span>
            <span class="k">return</span> <span class="n">probability</span><span class="p">,</span> <span class="n">ln_p</span></div>
     
<div class="viewcode-block" id="Particle.pi"><a class="viewcode-back" href="../index.html#abcsmc.Particle.pi">[docs]</a>    <span class="k">def</span> <span class="nf">pi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return probability of getting a particular theta by sampling at random from the prior.</span>
<span class="sd">        If theta is not specified, sample randomly from the prior.&quot;&quot;&quot;</span>
         
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_accepted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="c">## Calculate the chances of picking the accepted parameter set at random from the prior</span>
            <span class="n">probability</span> <span class="o">=</span> <span class="mf">1.0</span> 
            <span class="n">param_prior_pairs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_accepted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">prior</span> <span class="ow">in</span> <span class="n">param_prior_pairs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">probability</span> <span class="o">*=</span> <span class="n">prior</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">probability</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">prior</span>
            <span class="k">return</span> <span class="n">probability</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">## Sample from the prior</span>
            <span class="n">theta_proposed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">prior_iter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nditer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_set</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">param_prior</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prior_iter</span><span class="p">):</span>
                <span class="n">param_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">param_prior</span><span class="p">)</span>
                <span class="n">theta_proposed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_value</span>
            <span class="k">return</span> <span class="n">theta_proposed</span></div>
 
<div class="viewcode-block" id="Particle.conduct_experiments"><a class="viewcode-back" href="../index.html#abcsmc.Particle.conduct_experiments">[docs]</a>    <span class="k">def</span> <span class="nf">conduct_experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Conduct experiments for model in current state and return 1 - (balanced accuracy).&quot;&quot;&quot;</span>
         
<span class="c">#         ## Check that the model can run without changes, else return 1</span>
<span class="c">#         if self.model.opt() &lt;= 0:</span>
<span class="c">#             print(&quot;Failed on original media&quot;)</span>
<span class="c">#             self.result = 1</span>
<span class="c">#             return None</span>
        
        <span class="n">opt_cutoff</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">5</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">num_tests_checked</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_tests_total</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">Checking precalculated media ...                                     &quot;</span><span class="p">)</span>    
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="c">## Must run on all common media before experimental testing</span>
        <span class="k">for</span> <span class="n">precalc_medium</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">precalc_media</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_medium</span><span class="p">(</span><span class="n">precalc_medium</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">opt</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">opt_cutoff</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Failed on precalc media&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">None</span>
         
<span class="c">#         print&quot;No failure, continuing with test&quot;</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">Creating list of valid experiments ...                           &quot;</span><span class="p">)</span>    
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="c">## Check all genotypes for presence in model and create a list of valid experiments</span>
        <span class="n">valid_experiments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_pos_remaining</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_neg_remaining</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">gene_ids_in_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_relevant_gene_ids</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">expt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">):</span>
            <span class="n">all_genes_present</span> <span class="o">=</span> <span class="k">True</span>
            <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">expt</span><span class="o">.</span><span class="n">genotype</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gene</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gene_ids_in_model</span><span class="p">:</span>
<span class="c">#                     print(&quot;Expt {}: &#39;{}&#39; not present in model ...&quot;.format(idx+1, gene))</span>
                    <span class="n">all_genes_present</span> <span class="o">=</span> <span class="k">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">all_genes_present</span><span class="p">:</span>
                <span class="n">valid_experiments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">expt</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">num_pos_remaining</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">num_neg_remaining</span> <span class="o">+=</span> <span class="mi">1</span>
         
        <span class="bp">self</span><span class="o">.</span><span class="n">num_tests_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_experiments</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;{} valid experiments ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_experiments</span><span class="p">)))</span>
        
        <span class="n">num_failed_tests</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_succeeded_tests</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">tp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">running_results</span> <span class="o">=</span> <span class="n">ResultSet</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">min_dist</span> <span class="o">=</span> <span class="s">&#39;unk&#39;</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Beginning tests ...&quot;</span><span class="p">)</span>
        
        <span class="n">counter</span> <span class="o">=</span> <span class="n">loop_counter</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_experiments</span><span class="p">),</span> <span class="s">&quot;Testing experiments&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_experiments</span><span class="p">):</span>
            <span class="n">expt_result</span><span class="p">,</span> <span class="n">tp_add</span><span class="p">,</span> <span class="n">tn_add</span><span class="p">,</span> <span class="n">fp_add</span><span class="p">,</span> <span class="n">fn_add</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">precalc_media_frozensets</span><span class="p">)</span>
            <span class="n">running_results</span><span class="o">.</span><span class="n">tp</span> <span class="o">+=</span> <span class="n">tp_add</span>
            <span class="n">running_results</span><span class="o">.</span><span class="n">tn</span> <span class="o">+=</span> <span class="n">tn_add</span>
            <span class="n">running_results</span><span class="o">.</span><span class="n">fp</span> <span class="o">+=</span> <span class="n">fp_add</span>
            <span class="n">running_results</span><span class="o">.</span><span class="n">fn</span> <span class="o">+=</span> <span class="n">fn_add</span>            
            <span class="k">if</span> <span class="n">experiment</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">num_pos_remaining</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_neg_remaining</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">expt_result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">num_succeeded_tests</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">expt_result</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">expt_result</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">num_failed_tests</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c">## If it is impossible to get below epsilon with all following </span>
            <span class="c">## tests correct, stop early</span>
            <span class="k">if</span> <span class="n">fn_add</span> <span class="o">+</span> <span class="n">fp_add</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">check_results</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">running_results</span><span class="p">)</span>
                <span class="n">check_results</span><span class="o">.</span><span class="n">tp</span> <span class="o">+=</span> <span class="n">num_pos_remaining</span> 
                <span class="n">check_results</span><span class="o">.</span><span class="n">tn</span> <span class="o">+=</span> <span class="n">num_neg_remaining</span>
                <span class="n">min_dist</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">check_results</span><span class="o">.</span><span class="n">balanced_accuracy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">min_dist</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">counter</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>        
        <span class="n">counter</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_tests_checked</span> <span class="o">=</span> <span class="n">num_succeeded_tests</span> <span class="o">+</span> <span class="n">num_failed_tests</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">full_results</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">running_results</span><span class="p">)</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">running_results</span><span class="o">.</span><span class="n">balanced_accuracy</span><span class="p">()</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">distance</span>
        <span class="k">return</span> <span class="k">None</span></div>
    
<div class="viewcode-block" id="Particle.conduct_experiments_essential_and_orphan_mets"><a class="viewcode-back" href="../index.html#abcsmc.Particle.conduct_experiments_essential_and_orphan_mets">[docs]</a>    <span class="k">def</span> <span class="nf">conduct_experiments_essential_and_orphan_mets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Conduct experiments for model in current state and return 1 - (balanced accuracy).&quot;&quot;&quot;</span>
         
        <span class="n">opt_cutoff</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_tests_checked</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_tests_total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">Checking precalculated media ...                                     &quot;</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>    
        <span class="c">## Must run on all common media before experimental testing</span>
        <span class="k">for</span> <span class="n">precalc_medium</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">precalc_media</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_medium</span><span class="p">(</span><span class="n">precalc_medium</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot; =&gt; precalc: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">opt</span><span class="p">()),</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">opt</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">opt_cutoff</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Failed on precalc media&quot;</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">None</span> 

        <span class="c">## Check all genotypes for presence in model and create a list of valid experiments</span>
        <span class="n">valid_experiments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_pos_remaining</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_neg_remaining</span> <span class="o">=</span> <span class="mi">0</span>        
        <span class="n">gene_ids_in_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_relevant_gene_ids</span><span class="p">()</span>
        <span class="n">num_expts_essential</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">expt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expt</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">num_expts_essential</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">all_genes_present</span> <span class="o">=</span> <span class="k">True</span>
                <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">expt</span><span class="o">.</span><span class="n">genotype</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">gene</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gene_ids_in_model</span><span class="p">:</span>
                        <span class="n">all_genes_present</span> <span class="o">=</span> <span class="k">False</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">all_genes_present</span><span class="p">:</span>
                    <span class="n">valid_experiments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">expt</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">num_pos_remaining</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">num_neg_remaining</span> <span class="o">+=</span> <span class="mi">1</span>
         
        <span class="bp">self</span><span class="o">.</span><span class="n">num_tests_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_experiments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">{} valid experiments ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_experiments</span><span class="p">)),</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Beginning tests ...&quot;</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">num_tn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_fp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_tests_remaining</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_experiments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_tests_checked</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">valid_experiments</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tn_add</span><span class="p">,</span> <span class="n">fp_add</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">precalc_media_frozensets</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_tests_checked</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">num_tn</span> <span class="o">+=</span> <span class="n">tn_add</span>
            <span class="n">num_fp</span> <span class="o">+=</span> <span class="n">fp_add</span>
            <span class="n">num_tests_remaining</span> <span class="o">-=</span> <span class="mi">1</span>
                
            <span class="n">max_distance</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">num_tn</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_essential_expts</span>
            <span class="n">min_distance</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">num_tn</span> <span class="o">+</span> <span class="n">num_tests_remaining</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_essential_expts</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;{}</span><span class="se">\t</span><span class="s">{}</span><span class="se">\t</span><span class="s">{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_tests_remaining</span><span class="p">,</span><span class="n">min_distance</span><span class="p">,</span> <span class="n">max_distance</span><span class="p">),</span><span class="n">verbose</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">min_distance</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Minimum distance &gt; epsilon, aborting ...&quot;</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">min_distance</span>
                <span class="k">return</span> <span class="k">None</span>
            <span class="k">if</span> <span class="n">max_distance</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vprint</span><span class="p">(</span><span class="s">&quot;Maximum distance &lt; epsilon, finishing ...&quot;</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">min_distance</span>
                <span class="k">return</span> <span class="k">None</span>
            
        <span class="n">distance</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">num_tn</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_essential_expts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">distance</span>
        <span class="k">return</span> <span class="k">None</span></div></div>
        
<div class="viewcode-block" id="Experiment"><a class="viewcode-back" href="../index.html#abcsmc.Experiment">[docs]</a><span class="k">class</span> <span class="nc">Experiment</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The details of a real experiment formatted for testing a constraint-based model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expt_id</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">genotype</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="n">objective</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="n">old_expt</span> <span class="o">=</span> <span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">old_expt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">old_expt</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">medium</span> <span class="o">=</span> <span class="n">old_expt</span><span class="o">.</span><span class="n">medium</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">old_expt</span><span class="o">.</span><span class="n">result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span> <span class="o">=</span> <span class="n">old_expt</span><span class="o">.</span><span class="n">genotype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="n">old_expt</span><span class="o">.</span><span class="n">objective</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">expt_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">medium</span> <span class="o">=</span> <span class="n">medium</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;y&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span> <span class="o">=</span> <span class="n">genotype</span> <span class="ow">or</span> <span class="k">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="n">objective</span> <span class="ow">or</span> <span class="k">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">medium_components</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">component</span> <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">])</span>
    
<div class="viewcode-block" id="Experiment.test"><a class="viewcode-back" href="../index.html#abcsmc.Experiment.test">[docs]</a>    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ec_model</span><span class="p">,</span> <span class="n">precalc_frozensets</span> <span class="o">=</span> <span class="k">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate whether ec_model is consistent with this experiment.</span>
<span class="sd">        &quot;&quot;&quot;</span>  
        
        <span class="n">opt_cutoff</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">5</span>
        
        <span class="n">precalc_frozensets</span> <span class="o">=</span> <span class="n">precalc_frozensets</span> <span class="ow">or</span> <span class="p">[]</span>
        
        <span class="n">ec_model</span><span class="o">.</span><span class="n">set_medium</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">:</span>
            <span class="n">ec_model</span><span class="o">.</span><span class="n">change_objective</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">)</span>
        
        <span class="n">change_to_model</span> <span class="o">=</span> <span class="n">ec_model</span><span class="o">.</span><span class="n">set_genotype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">change_to_model</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">medium_components</span> <span class="ow">in</span> <span class="n">precalc_frozensets</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> 
        <span class="k">elif</span> <span class="n">change_to_model</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c">## Gene is not in model.</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
        <span class="n">model_growth</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">(</span><span class="n">ec_model</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ec_model</span><span class="o">.</span><span class="n">unset_genotype</span><span class="p">()</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">model_growth</span> <span class="o">&gt;</span> <span class="n">opt_cutoff</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">expt_result</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">model_growth</span> <span class="o">&lt;=</span> <span class="n">opt_cutoff</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">expt_result</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">tn</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expt_result</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">expt_result</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span></div></div>
        
<div class="viewcode-block" id="create_extended_model"><a class="viewcode-back" href="../index.html#abcsmc.create_extended_model">[docs]</a><span class="k">def</span> <span class="nf">create_extended_model</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="n">objective_id</span> <span class="o">=</span> <span class="s">&#39;Biomass_BT_v2&#39;</span><span class="p">,</span> <span class="n">require_solver</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s">&#39;cglpk&#39;</span><span class="p">,</span><span class="n">tidy_ids</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Take an ArrayBasedModel and convert to an Extended_Cobra_Model.&quot;&quot;&quot;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Creating extended COBRA model&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_cobra_model_from_sbml_file</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span>
    <span class="n">ecm_model</span> <span class="o">=</span> <span class="n">ExtendedCobraModel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">ecm_model</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">require_solver</span><span class="o">=</span><span class="n">require_solver</span><span class="p">)</span>
    <span class="n">ecm_model</span><span class="o">.</span><span class="n">set_medium</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s">&quot;done.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ecm_model</span><span class="o">.</span><span class="n">change_objective</span><span class="p">(</span><span class="n">objective_id</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Objective could not be set ...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tidy_ids</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">ecm_model</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
            <span class="n">newID</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;_LPAREN_&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="n">newID</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;_RPAREN_&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">newID</span><span class="p">)</span>
            <span class="n">newID</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;\(&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="n">newID</span><span class="p">)</span>
            <span class="n">newID</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;\)&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">newID</span><span class="p">)</span>
            <span class="n">newID</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;_LSQBKT_&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="n">newID</span><span class="p">)</span>
            <span class="n">newID</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;_RSQBKT_&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">newID</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newID</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_er&#39;</span><span class="p">):</span>
                <span class="n">newID</span> <span class="o">=</span> <span class="n">newID</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>           
            <span class="n">rxn</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">newID</span>       
        <span class="n">ecm_model</span><span class="o">.</span><span class="n">repair</span><span class="p">()</span> 
        <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">ecm_model</span><span class="o">.</span><span class="n">genes</span><span class="p">:</span>
            <span class="n">gene_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;^(G_)+&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">gene</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">gene</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">gene_id</span>
        <span class="n">ecm_model</span><span class="o">.</span><span class="n">repair</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="n">ecm_model</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
            <span class="n">grr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;(G_)&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">reaction</span><span class="o">.</span><span class="n">gene_reaction_rule</span><span class="p">)</span>
            <span class="n">reaction</span><span class="o">.</span><span class="n">gene_reaction_rule</span> <span class="o">=</span> <span class="n">grr</span>        
        <span class="n">ecm_model</span><span class="o">.</span><span class="n">repair</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ecm_model</span>    </div>

<div class="viewcode-block" id="ExtendedCobraModel"><a class="viewcode-back" href="../index.html#abcsmc.ExtendedCobraModel">[docs]</a><span class="k">class</span> <span class="nc">ExtendedCobraModel</span><span class="p">(</span><span class="n">ArrayBasedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Additional functionality for helping to use COBRA model.&quot;&quot;&quot;</span>
            
<div class="viewcode-block" id="ExtendedCobraModel.get_relevant_gene_ids"><a class="viewcode-back" href="../index.html#abcsmc.ExtendedCobraModel.get_relevant_gene_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_relevant_gene_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of gene IDs for all genes implicated in non-zero flux reactions.&quot;&quot;&quot;</span>
        
        <span class="n">relevant_genes_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">reaction</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">!=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">reaction</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">gene_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">gene</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">reaction</span><span class="o">.</span><span class="n">genes</span><span class="p">]</span>
                <span class="n">relevant_genes_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">gene_ids</span><span class="p">)</span>
        <span class="n">relevant_genes_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">relevant_genes_list</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">relevant_genes_list</span></div>
    
<div class="viewcode-block" id="ExtendedCobraModel.split_rxn_by_enzymes"><a class="viewcode-back" href="../index.html#abcsmc.ExtendedCobraModel.split_rxn_by_enzymes">[docs]</a>    <span class="k">def</span> <span class="nf">split_rxn_by_enzymes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_id</span><span class="p">,</span> <span class="n">enzyme_limit</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Take a reaction from the model and add new reactions for each potential enzyme.</span>
<span class="sd">        </span>
<span class="sd">        Do not split the reaction if the number of predicted enzymes is &gt; enzyme_limit.</span>
<span class="sd">        </span>
<span class="sd">        Original reaction is retained as a &#39;hypothetical&#39; (unidentified) enzyme.</span>
<span class="sd">        </span>
<span class="sd">        Return list of IDs created for these enzrxns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">rxn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">reaction_id</span><span class="p">)</span>
        <span class="n">gpr_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enzymes_as_gprs</span><span class="p">(</span><span class="n">rxn</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpr_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">enzyme_limit</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="k">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpr_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="n">rxn</span><span class="o">.</span><span class="n">id</span>
        <span class="n">enzyme_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">enzrxn_id_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gpr</span> <span class="ow">in</span> <span class="n">gpr_list</span><span class="p">:</span>
            <span class="n">enzyme_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">rxn_dup</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">rxn</span><span class="p">)</span>
            <span class="n">rxn_dup</span><span class="o">.</span><span class="n">gene_reaction_rule</span> <span class="o">=</span> <span class="n">gpr</span>
            <span class="n">rxn_dup</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">rxn_dup</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&quot;_enz&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">enzyme_index</span><span class="p">)</span>
            <span class="n">enzrxn_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_dup</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_reaction</span><span class="p">(</span><span class="n">rxn_dup</span><span class="p">)</span>
        <span class="n">rxn</span><span class="o">.</span><span class="n">gene_reaction_rule</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">enzrxn_id_list</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">id</span></div>
        
<div class="viewcode-block" id="ExtendedCobraModel.enzyme_to_gpr"><a class="viewcode-back" href="../index.html#abcsmc.ExtendedCobraModel.enzyme_to_gpr">[docs]</a>    <span class="k">def</span> <span class="nf">enzyme_to_gpr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enzyme_string</span><span class="p">,</span> <span class="n">warn_if_absent</span> <span class="o">=</span> <span class="k">False</span><span class="p">,</span> <span class="n">reject_if_absent</span> <span class="o">=</span> <span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert enzyme string to GPR string.</span>
<span class="sd">        Enzyme string should be a comma separated list of valid </span>
<span class="sd">        gene loci.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">gene_ids</span> <span class="o">=</span> <span class="n">enzyme_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reject_if_absent</span> <span class="ow">or</span> <span class="n">warn_if_absent</span><span class="p">:</span>
            <span class="n">genes_model_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genes</span><span class="p">:</span>
                <span class="n">genes_model_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gene</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">reject</span> <span class="o">=</span> <span class="k">False</span> 
        <span class="k">for</span> <span class="n">gene_id</span> <span class="ow">in</span> <span class="n">gene_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reject_if_absent</span> <span class="ow">or</span> <span class="n">warn_if_absent</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gene_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">genes_model_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">warn_if_absent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Gene {} not currently in model&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gene_id</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">reject_if_absent</span><span class="p">:</span>
                        <span class="n">reject</span> <span class="o">=</span> <span class="k">True</span>
        <span class="k">if</span> <span class="n">reject</span> <span class="o">==</span> <span class="k">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot; - Gene(s) not in current model, conversion aborted.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gpr_string</span> <span class="o">=</span>\
                <span class="s">&quot;( &quot;</span> <span class="o">+</span>\
                <span class="s">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gene_ids</span><span class="p">)</span> <span class="o">+</span>\
                <span class="s">&quot; )&quot;</span>
            <span class="k">return</span> <span class="n">gpr_string</span></div>
    
    
<div class="viewcode-block" id="ExtendedCobraModel.enzymes_as_gprs"><a class="viewcode-back" href="../index.html#abcsmc.ExtendedCobraModel.enzymes_as_gprs">[docs]</a>    <span class="k">def</span> <span class="nf">enzymes_as_gprs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Expand the GPR for the given reaction and list all enzymes as separate GPRs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">enzymes</span> <span class="o">=</span> <span class="n">gene_parser</span><span class="p">(</span><span class="n">reaction</span><span class="o">.</span><span class="n">gene_reaction_rule</span><span class="p">)</span>
        <span class="n">gpr_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">enzyme</span> <span class="ow">in</span> <span class="n">enzymes</span><span class="p">:</span>
            <span class="n">gpr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enzyme_to_gpr</span><span class="p">(</span><span class="n">enzyme</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">gpr_list</span></div>
        
<div class="viewcode-block" id="ExtendedCobraModel.set_genotype"><a class="viewcode-back" href="../index.html#abcsmc.ExtendedCobraModel.set_genotype">[docs]</a>    <span class="k">def</span> <span class="nf">set_genotype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genotype</span><span class="p">,</span> <span class="n">return_ko_rxns</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run delete_model_genes on model.  Return False if no change is made to the model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">genotype</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">2</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c">## CODE FROM COBRAPY: to access reaction deletions</span>
            <span class="c"># Allow a single gene to be fed in as a string instead of a list.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">genotype</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">genotype</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">):</span>
                <span class="n">genotype</span> <span class="o">=</span> <span class="p">[</span><span class="n">genotype</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">genotype</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;id&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">genotype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genes</span><span class="p">:</span>
                    <span class="n">tmp_gene_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genes</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># assume we&#39;re dealing with names if no match to an id</span>
                    <span class="n">tmp_gene_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genes</span><span class="p">])</span>
                <span class="n">genotype</span> <span class="o">=</span> <span class="p">[</span><span class="n">tmp_gene_dict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">genotype</span><span class="p">]</span>    
            <span class="c"># Make the genes non-functional</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">genotype</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">functional</span> <span class="o">=</span> <span class="k">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">knocked_out_reactions</span> <span class="o">=</span> <span class="n">find_gene_knockout_reactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genotype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_ko_rxns</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">knocked_out_reactions</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">knocked_out_reactions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delete_model_genes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genotype</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span></div>
        
<div class="viewcode-block" id="ExtendedCobraModel.unset_genotype"><a class="viewcode-back" href="../index.html#abcsmc.ExtendedCobraModel.unset_genotype">[docs]</a>    <span class="k">def</span> <span class="nf">unset_genotype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run undelete_model_genes on model.</span>
<span class="sd">        &quot;&quot;&quot;</span>    
        <span class="n">undelete_model_genes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
        
    
    <span class="k">def</span> <span class="nf">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver_string</span> <span class="o">=</span> <span class="s">&#39;cglpk&#39;</span><span class="p">,</span> <span class="n">require_solver</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="n">solver_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver_string</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s">&#39;glpk&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s">&#39;glpk&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">require_solver</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="k">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s">&#39;glpk&#39;</span><span class="p">)</span>
                    
        
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Solver is &#39;{}&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">))</span>
        
        
    <span class="k">def</span> <span class="nf">opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_objective</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_objective</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_objective</span><span class="p">(</span><span class="n">new_objective</span><span class="p">)</span>
        
<span class="c">#         sys.stdout.write(&quot;\rrunning optimize() ...                         &quot;)    </span>
<span class="c">#         sys.stdout.flush()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="n">time_limit</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            
<span class="c">#             print(&quot;Optimize failed.&quot;)</span>
<span class="c">#             print(&quot;Solver: &#39;{}&#39;&quot;.format(self.solver))</span>
<span class="c">#             print(&quot;Time limit: {}&quot;.format(time_limit))</span>
            <span class="k">return</span> <span class="mi">0</span>

<span class="c">#         sys.stdout.write(&quot;\rfinished running optimize() ...                &quot;)    </span>
<span class="c">#         sys.stdout.flush()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">f</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="c">#                 print(&quot;Solution less than 0.&quot;)</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">f</span>
        <span class="k">else</span><span class="p">:</span>
<span class="c">#             print(&quot;No solution.&quot;)</span>
            <span class="k">return</span> <span class="mi">0</span>
    
<div class="viewcode-block" id="ExtendedCobraModel.set_medium"><a class="viewcode-back" href="../index.html#abcsmc.ExtendedCobraModel.set_medium">[docs]</a>    <span class="k">def</span> <span class="nf">set_medium</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">medium_dict</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set exchanges of all &quot;EX_&quot; reactions to zero, or what is in medium_dict.</span>
<span class="sd">        medium_dict: key = reaction ID, value = new lower bound.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exchange_rxn_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reaction</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;EX_&quot;</span><span class="p">:</span>
                <span class="c">## Exchange reaction, so if lb &lt; 0, print</span>
                <span class="n">reaction</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">exchange_rxn_dict</span><span class="p">[</span><span class="n">reaction</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">reaction</span>
        <span class="k">if</span> <span class="n">medium_dict</span><span class="p">:</span> 
            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">medium_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">exchange_rxn_dict</span><span class="p">:</span>
                    <span class="n">exchange_rxn_dict</span><span class="p">[</span><span class="n">component</span><span class="p">]</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">=</span> <span class="n">medium_dict</span><span class="p">[</span><span class="n">component</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s">&#39;EX_&#39;</span> <span class="o">+</span> <span class="n">component</span> <span class="o">+</span> <span class="s">&#39;(e)&#39;</span> <span class="ow">in</span> <span class="n">exchange_rxn_dict</span><span class="p">:</span>
                    <span class="n">exchange_rxn_dict</span><span class="p">[</span><span class="s">&#39;EX_&#39;</span> <span class="o">+</span> <span class="n">component</span> <span class="o">+</span> <span class="s">&#39;(e)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">=</span> <span class="n">medium_dict</span><span class="p">[</span><span class="n">component</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Reaction ID &#39;{}&#39; not found, ignoring ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium_dict</span> <span class="o">=</span> <span class="n">medium_dict</span></div>
               
<div class="viewcode-block" id="ExtendedCobraModel.show_medium"><a class="viewcode-back" href="../index.html#abcsmc.ExtendedCobraModel.show_medium">[docs]</a>    <span class="k">def</span> <span class="nf">show_medium</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all exchange lower bounds &lt; 0 and print to screen.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reaction</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;EX_&quot;</span><span class="p">):</span>
                <span class="c">## Exchange reaction, so if lb &lt; 0, print</span>
                <span class="k">if</span> <span class="n">reaction</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">reaction_identifier</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">reaction</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s">&quot;%45s %5.0f %5.0f&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reaction_identifier</span><span class="p">,</span> <span class="n">reaction</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">reaction</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">))</span></div></div>
    
<div class="viewcode-block" id="conduct_experiments"><a class="viewcode-back" href="../index.html#abcsmc.conduct_experiments">[docs]</a><span class="k">def</span> <span class="nf">conduct_experiments</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">debug</span> <span class="o">=</span> <span class="k">False</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Conduct experiments for model in current state and return 1 - (balanced accuracy).&quot;&quot;&quot;</span>
          
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">Creating list of valid experiments ...                           &quot;</span><span class="p">)</span>    
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="c">## Check all genotypes for presence in model and create a list of valid experiments</span>
    <span class="n">valid_experiments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num_pos_remaining</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_neg_remaining</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">gene_ids_in_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_relevant_gene_ids</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">expt</span> <span class="ow">in</span> <span class="n">experiments</span><span class="p">:</span>
        <span class="n">all_genes_present</span> <span class="o">=</span> <span class="k">True</span>
        <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">expt</span><span class="o">.</span><span class="n">genotype</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gene</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gene_ids_in_model</span><span class="p">:</span>
                <span class="n">all_genes_present</span> <span class="o">=</span> <span class="k">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">all_genes_present</span><span class="p">:</span>
            <span class="n">valid_experiments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expt</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">num_pos_remaining</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_neg_remaining</span> <span class="o">+=</span> <span class="mi">1</span>
     
    <span class="nb">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">{} valid experiments ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_experiments</span><span class="p">)))</span>
    
    <span class="n">num_failed_tests</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_succeeded_tests</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="n">running_results</span> <span class="o">=</span> <span class="n">ResultSet</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Beginning tests ...&quot;</span><span class="p">)</span>
    
    <span class="n">counter</span> <span class="o">=</span> <span class="n">loop_counter</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_experiments</span><span class="p">),</span> <span class="s">&quot;Testing experiments&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">valid_experiments</span><span class="p">:</span>
        <span class="n">expt_result</span><span class="p">,</span> <span class="n">tp_add</span><span class="p">,</span> <span class="n">tn_add</span><span class="p">,</span> <span class="n">fp_add</span><span class="p">,</span> <span class="n">fn_add</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">running_results</span><span class="o">.</span><span class="n">tp</span> <span class="o">+=</span> <span class="n">tp_add</span>
        <span class="n">running_results</span><span class="o">.</span><span class="n">tn</span> <span class="o">+=</span> <span class="n">tn_add</span>
        <span class="n">running_results</span><span class="o">.</span><span class="n">fp</span> <span class="o">+=</span> <span class="n">fp_add</span>
        <span class="n">running_results</span><span class="o">.</span><span class="n">fn</span> <span class="o">+=</span> <span class="n">fn_add</span>        
        <span class="k">if</span> <span class="n">experiment</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">num_pos_remaining</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_neg_remaining</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">expt_result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">num_succeeded_tests</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">expt_result</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">expt_result</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">num_failed_tests</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">counter</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    
    <span class="n">counter</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="n">num_tests_checked</span> <span class="o">=</span> <span class="n">num_succeeded_tests</span> <span class="o">+</span> <span class="n">num_failed_tests</span>
    <span class="n">full_results</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">running_results</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">full_results</span><span class="p">,</span> <span class="n">num_tests_checked</span>        </div>

<div class="viewcode-block" id="timeout"><a class="viewcode-back" href="../index.html#abcsmc.timeout">[docs]</a><span class="k">def</span> <span class="nf">timeout</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">timeout_duration</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run func, but exit after timeout_duration if func hasn&#39;t completed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">signal</span>
    <span class="k">class</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">()</span>
    <span class="c"># set the timeout handler</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span> 
    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout_duration</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">timed out ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">default</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="import_prior_dict"><a class="viewcode-back" href="../index.html#abcsmc.import_prior_dict">[docs]</a><span class="k">def</span> <span class="nf">import_prior_dict</span><span class="p">(</span>
        <span class="n">prior_files</span><span class="p">,</span>
        <span class="n">rem_default</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
        <span class="n">add_default</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create prior dictionary from prior files, giving default prior values </span>
<span class="sd">    where not specified.&quot;&quot;&quot;</span>
    <span class="n">prior_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prior_files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">prior_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">prior_files</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">prior_files</span><span class="p">:</span>
        <span class="n">f_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;rem&quot;</span><span class="p">:</span>
                <span class="n">prior_dict</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">rem_default</span>
            <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;add&quot;</span><span class="p">:</span>
                <span class="n">prior_dict</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">add_default</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prior_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">prior_dict</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">prior_val</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">f_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">prior_dict</span>      </div>

<div class="viewcode-block" id="import_media"><a class="viewcode-back" href="../index.html#abcsmc.import_media">[docs]</a><span class="k">def</span> <span class="nf">import_media</span><span class="p">(</span><span class="n">media_shelf_file</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import media values from a media shelf file for input into experiments.&quot;&quot;&quot;</span>
    <span class="n">media_shelf_file</span> <span class="o">=</span> <span class="n">media_shelf_file</span> <span class="ow">or</span> <span class="s">&#39;/Users/wbryant/work/BTH/analysis/fba/media.data&#39;</span>
    <span class="n">media_shelf</span> <span class="o">=</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">media_shelf_file</span><span class="p">)</span>
    <span class="n">media</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">media</span><span class="p">[</span><span class="s">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">media_shelf</span><span class="p">[</span><span class="s">&#39;min&#39;</span><span class="p">]</span>
    <span class="n">media</span><span class="p">[</span><span class="s">&#39;tyg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">media_shelf</span><span class="p">[</span><span class="s">&#39;tyg&#39;</span><span class="p">]</span>
    <span class="n">media_shelf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">media</span></div>
    
<div class="viewcode-block" id="import_expt_data"><a class="viewcode-back" href="../index.html#abcsmc.import_expt_data">[docs]</a><span class="k">def</span> <span class="nf">import_expt_data</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">objective_id</span><span class="o">=</span><span class="s">&quot;Biomass_BT_v2&quot;</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">data_file</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;From a table of genotype/growth information, create the experiments </span>
<span class="sd">    for a particular organism.</span>
<span class="sd">    </span>
<span class="sd">    If there are any lines at the top of the file starting with the word </span>
<span class="sd">    &quot;MEDIUM&quot; in the first column the next column will be the medium name and </span>
<span class="sd">    the following cells will contain medium components for specifying media </span>
<span class="sd">    used in the experiments. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Importing data ...&quot;</span><span class="p">)</span>
    <span class="n">objective</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">objective_id</span><span class="p">)</span>
    <span class="n">data_file</span> <span class="o">=</span> <span class="n">data_file</span> <span class="ow">or</span> <span class="s">&#39;/Users/wbryant/work/BTH/analysis/gene_essentiality/essentiality_data_complete.csv&#39;</span>
    <span class="n">experiments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">expts_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">media</span><span class="p">:</span>
        <span class="n">media</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">expts_in</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;#&quot;</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;MEDIUM&#39;</span><span class="p">:</span>
                <span class="n">medium_name</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">medium_components</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="n">medium_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">medium_components</span><span class="p">:</span>
                    <span class="n">medium_dict</span><span class="p">[</span><span class="n">component</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">media</span><span class="p">[</span><span class="n">medium_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">medium_dict</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">set_medium</span><span class="p">(</span><span class="n">medium_dict</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Medium &#39;{}&#39; cannot be set on the model - incorrect component ID?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">medium_name</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">medium_components</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="s">&quot; - {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="p">))</span>        
            <span class="k">else</span><span class="p">:</span>
                <span class="n">medium_base</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">c_source</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">genotype</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; and &quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">c_sources</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c">## Add carbon source to medium</span>
                <span class="k">if</span> <span class="n">c_source</span> <span class="o">==</span> <span class="s">&quot;-&quot;</span><span class="p">:</span>
                    <span class="n">c_sources</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">elif</span> <span class="s">&#39;and&#39;</span> <span class="ow">in</span> <span class="n">c_source</span><span class="p">:</span>
                    <span class="n">c_sources</span> <span class="o">=</span> <span class="n">c_source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; and &#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c_source</span><span class="p">:</span>
                    <span class="n">c_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">c_source</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c_sources</span> <span class="o">=</span> <span class="k">None</span>
                <span class="n">expt_medium</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">media</span><span class="p">[</span><span class="n">medium_base</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">c_sources</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">c_sources</span><span class="p">:</span>
                        <span class="n">c_source_exchange</span> <span class="o">=</span> <span class="s">&quot;EX_&quot;</span> <span class="o">+</span> <span class="n">source</span> <span class="o">+</span> <span class="s">&quot;_e&quot;</span>
                        <span class="n">expt_medium</span><span class="p">[</span><span class="n">c_source_exchange</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
                <span class="n">experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">expt_medium</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">genotype</span><span class="p">,</span> <span class="n">objective</span><span class="p">)</span>
                <span class="n">experiments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
    <span class="n">expts_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">experiments</span></div>

<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">floor</span>

<div class="viewcode-block" id="loop_counter"><a class="viewcode-back" href="../index.html#abcsmc.loop_counter">[docs]</a><span class="k">class</span> <span class="nc">loop_counter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Use to track progress of a loop of known length.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;Entering loop&#39;</span><span class="p">,</span> <span class="n">timed</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">add_delay</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="k">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_done</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_progress</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percent_done</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timed</span> <span class="o">=</span> <span class="n">timed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_delay</span> <span class="o">=</span> <span class="n">add_delay</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;{}:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_delay</span><span class="p">:</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s"> - 0 %%&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_done</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_done</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">percent_done</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="mf">1000.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_done</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_delay</span><span class="p">:</span>
                        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s"> - {} % ({} / {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">percent_done</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">num_done</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">length</span>
                    <span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_delay</span><span class="p">:</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s"> - 100 % ({})                        </span><span class="se">\n</span><span class="s">&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="k">True</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="ResultSet"><a class="viewcode-back" href="../index.html#abcsmc.ResultSet">[docs]</a><span class="k">class</span> <span class="nc">ResultSet</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A container for a set of results that can return stats&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tn</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tn</span> <span class="o">=</span> <span class="n">tn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span>
    
    <span class="k">def</span> <span class="nf">precision</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">recall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
            
    <span class="k">def</span> <span class="nf">f_measure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">()</span>
        <span class="n">recall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recall</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">precision</span><span class="o">*</span><span class="n">recall</span><span class="o">/</span><span class="p">(</span><span class="n">precision</span> <span class="o">+</span> <span class="n">recall</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">accuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tn</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">balanced_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tn</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tn</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
    
<div class="viewcode-block" id="ResultSet.max_balanced_accuracy"><a class="viewcode-back" href="../index.html#abcsmc.ResultSet.max_balanced_accuracy">[docs]</a>    <span class="k">def</span> <span class="nf">max_balanced_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_tests_remaining</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a number of tests to be added to the results, what is the </span>
<span class="sd">        maximum balanced accuracy that could be achieved?  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">pass</span></div>
    
    <span class="k">def</span> <span class="nf">calc_balanced_tfpn_addition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_tests_remaining</span><span class="p">):</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tn</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="o">*</span><span class="n">num_tests_remaining</span>
        
        <span class="n">x</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">numerator</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">denominator</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">num_tests_remaining</span> <span class="o">-</span> <span class="n">x</span>
        
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
         
        
        
    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">()</span>
            <span class="n">recall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recall</span><span class="p">()</span>
            <span class="n">f_measure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_measure</span><span class="p">()</span>
            <span class="n">accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accuracy</span><span class="p">()</span>
            <span class="n">balanced_accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balanced_accuracy</span><span class="p">()</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;tp</span><span class="se">\t</span><span class="s">tn</span><span class="se">\t</span><span class="s">fp</span><span class="se">\t</span><span class="s">fn&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;{}</span><span class="se">\t</span><span class="s">{}</span><span class="se">\t</span><span class="s">{}</span><span class="se">\t</span><span class="s">{}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tn</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fn</span>
            <span class="p">))</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;%12s = %1.3f&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Precision&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;%12s = %1.3f&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Recall&#39;</span><span class="p">,</span> <span class="n">recall</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;%12s = %1.3f&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;F-measure&#39;</span><span class="p">,</span> <span class="n">f_measure</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;%12s = %1.3f&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;%12s = %1.3f&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Bal. Accuracy&#39;</span><span class="p">,</span> <span class="n">balanced_accuracy</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;There are no true positives.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;tp</span><span class="se">\t</span><span class="s">tn</span><span class="se">\t</span><span class="s">fp</span><span class="se">\t</span><span class="s">fn&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;{}</span><span class="se">\t</span><span class="s">{}</span><span class="se">\t</span><span class="s">{}</span><span class="se">\t</span><span class="s">{}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tn</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fn</span>
            <span class="p">))</span></div>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Dr William Bryant.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>